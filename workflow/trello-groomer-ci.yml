trello_groomer_build:
  image: docker:latest
  stage: build
  tags:
    - local
    - docker
  variables:
    REPO: $REPO
    BRANCH: $BRANCH
    # DOCKER_HOST: tcp://docker:2375
    # DOCKER_DRIVER: overlay2
    # DOCKER_TLS_CERTDIR: "" # Disable TLS for Docker-in-Docker
  before_script:
    - apk add --no-cache git
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
  script:
    - rm -rf ./source-code
    - git clone --depth 1 --branch "$BRANCH" "https://github.com/sth144/$REPO.git" source-code
    - cd ./source-code
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker buildx create --use
    - |
      docker buildx build \
        --platform linux/arm/v7 \
        --target build \
        -t "$DOCKER_USERNAME/$REPO:$BRANCH-build" \
        . \
        --push
    # buildx doesn't store images...
    - docker pull "$DOCKER_USERNAME/$REPO:$BRANCH-build"
    - docker save $DOCKER_USERNAME/$REPO:$BRANCH-build -o ./build-image.tar
    - ls
    - |
      docker buildx build \
        --platform linux/arm/v7 \
        --target deploy \
        -t "$DOCKER_USERNAME/$REPO:$BRANCH \
        -t "$DOCKER_USERNAME/$REPO:latest" \
        . \
        --push
  cache:
    key: "$CI_COMMIT_REF_NAME"
    paths:
      - source-code/
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $REPO == "trello-groomer"

trello_groomer_test:
  stage: test
  image: docker:latest
  tags:
    - local
    - docker
  variables:
    REPO: $REPO
    BRANCH: $BRANCH
  dependencies:
    - trello_groomer_build
  cache:
    key: "$CI_COMMIT_REF_NAME"
    paths:
      - source-code/
  before_script:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
  script:
    - cd ./source-code
    - ls
    - docker load -i ./build-image.tar
    - docker build --target test -t $REPO:test .
    - docker run --rm $REPO:test
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $REPO == "trello-groomer"

trello_groomer_deploy:
  image: bitnami/kubectl:latest
  stage: deploy
  tags:
    - k8s
  dependencies:
    - trello_groomer_build
    - trello_groomer_test
  before_script:
    - echo "$KUBE_CA_PEM" | base64 -d > ca.crt
    - |
      cat <<EOF > kubeconfig
      apiVersion: v1
      clusters:
        - cluster:
            certificate-authority-data: $K8S_CA_PEM
            server: https://192.168.1.240:6443
          name: kubernetes
      contexts:
        - context:
            cluster: kubernetes
            user: kubernetes-admin
          name: kubernetes-admin@kubernetes
      current-context: kubernetes-admin@kubernetes
      kind: Config
      preferences: {}
      users:
        - name: kubernetes-admin
          user:
            client-certificate-data: $K8S_CLIENT_CERT
            client-key-data: $K8S_CLIENT_KEY
      EOF
    - export KUBECONFIG=$PWD/kubeconfig
    - cat ./kubeconfig
  script:
    # - kubectl config set-cluster kubernetes --server=$K8S_API_SERVER --insecure-skip-tls-verify=true
    # - kubectl config set-credentials deployer --token=$K8S_TOKEN
    # - kubectl config set-context default --cluster=kubernetes --user=deployer --namespace=default
    # - kubectl config use-context default

    - kubectl get nodes
    - kubectl get pods

    # Force a redeploy with annotation (Option 1)
    - export NOW=$(date +%s)
    - kubectl patch deployment trello-groomer-todo --type=merge --patch "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"ci-refresh\":\"$NOW\"}}}}}"

    # OR update image (Option 2)
    # - kubectl set image deployment/$DEPLOYMENT_NAME $CONTAINER_NAME=$DOCKER_IMAGE:$CI_COMMIT_REF_NAME
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $REPO == "trello-groomer"

trello_groomer_ci_loaded:
  stage: preflight
  tags:
    - k8s
  script:
    - echo "Loaded Trello Groomer CI configuration"
