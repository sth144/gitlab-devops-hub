trello_groomer_ci:
  image: docker:latest
  services:
    - docker:dind
  stage: build
  tags:
    # - k8s
    - docker
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "" # Disable TLS for Docker-in-Docker
    REPO: $REPO
    BRANCH: $BRANCH
  before_script:
    - apk add --no-cache git
  script:
    - git clone --depth 1 --branch "$BRANCH" "https://github.com/sth144/$REPO.git"
    - cd "$REPO"
    - docker build -t "$DOCKER_USERNAME/$REPO:$BRANCH" .
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push "$DOCKER_USERNAME/$REPO:$BRANCH"
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $REPO == "trello-groomer"

trello_groomer_ci_loaded:
  stage: preflight
  tags:
    - k8s
  script:
    - echo "Loaded Trello Groomer CI configuration"
